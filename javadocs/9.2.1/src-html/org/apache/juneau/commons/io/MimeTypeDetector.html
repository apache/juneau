<!DOCTYPE HTML>
<html lang>
<head>
<!-- Generated by javadoc (17) -->
<title>Source code</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="source: package: org.apache.juneau.commons.io, class: MimeTypeDetector">
<meta name="generator" content="javadoc/SourceToHTMLConverter">
<link rel="stylesheet" type="text/css" href="../../../../../../javadoc.css" title="Style">
</head>
<body class="source-page">
<main role="main">
<div class="source-container">
<pre><span class="source-line-no">001</span><span id="line-1">/*</span>
<span class="source-line-no">002</span><span id="line-2"> * Licensed to the Apache Software Foundation (ASF) under one or more</span>
<span class="source-line-no">003</span><span id="line-3"> * contributor license agreements.  See the NOTICE file distributed with</span>
<span class="source-line-no">004</span><span id="line-4"> * this work for additional information regarding copyright ownership.</span>
<span class="source-line-no">005</span><span id="line-5"> * The ASF licenses this file to You under the Apache License, Version 2.0</span>
<span class="source-line-no">006</span><span id="line-6"> * (the "License"); you may not use this file except in compliance with</span>
<span class="source-line-no">007</span><span id="line-7"> * the License.  You may obtain a copy of the License at</span>
<span class="source-line-no">008</span><span id="line-8"> *</span>
<span class="source-line-no">009</span><span id="line-9"> *      http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="source-line-no">010</span><span id="line-10"> *</span>
<span class="source-line-no">011</span><span id="line-11"> * Unless required by applicable law or agreed to in writing, software</span>
<span class="source-line-no">012</span><span id="line-12"> * distributed under the License is distributed on an "AS IS" BASIS,</span>
<span class="source-line-no">013</span><span id="line-13"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="source-line-no">014</span><span id="line-14"> * See the License for the specific language governing permissions and</span>
<span class="source-line-no">015</span><span id="line-15"> * limitations under the License.</span>
<span class="source-line-no">016</span><span id="line-16"> */</span>
<span class="source-line-no">017</span><span id="line-17">package org.apache.juneau.commons.io;</span>
<span class="source-line-no">018</span><span id="line-18"></span>
<span class="source-line-no">019</span><span id="line-19">import static org.apache.juneau.commons.collections.CacheMode.*;</span>
<span class="source-line-no">020</span><span id="line-20">import static org.apache.juneau.commons.utils.AssertionUtils.*;</span>
<span class="source-line-no">021</span><span id="line-21">import static org.apache.juneau.commons.utils.FileUtils.*;</span>
<span class="source-line-no">022</span><span id="line-22">import static org.apache.juneau.commons.utils.Utils.*;</span>
<span class="source-line-no">023</span><span id="line-23"></span>
<span class="source-line-no">024</span><span id="line-24">import java.nio.file.*;</span>
<span class="source-line-no">025</span><span id="line-25">import java.util.*;</span>
<span class="source-line-no">026</span><span id="line-26">import java.util.concurrent.*;</span>
<span class="source-line-no">027</span><span id="line-27"></span>
<span class="source-line-no">028</span><span id="line-28">import org.apache.juneau.commons.collections.*;</span>
<span class="source-line-no">029</span><span id="line-29"></span>
<span class="source-line-no">030</span><span id="line-30">/**</span>
<span class="source-line-no">031</span><span id="line-31"> * A lightweight MIME type detector that doesn't require Jakarta Activation.</span>
<span class="source-line-no">032</span><span id="line-32"> *</span>
<span class="source-line-no">033</span><span id="line-33"> * &lt;p&gt;</span>
<span class="source-line-no">034</span><span id="line-34"> * This class provides MIME type detection using multiple strategies:</span>
<span class="source-line-no">035</span><span id="line-35"> * &lt;ol&gt;</span>
<span class="source-line-no">036</span><span id="line-36"> *   &lt;li&gt;Java NIO's {@link Files#probeContentType(Path)} for content-based detection</span>
<span class="source-line-no">037</span><span id="line-37"> *   &lt;li&gt;Extension-based mapping for common file types</span>
<span class="source-line-no">038</span><span id="line-38"> *   &lt;li&gt;Configurable MIME type mappings</span>
<span class="source-line-no">039</span><span id="line-39"> * &lt;/ol&gt;</span>
<span class="source-line-no">040</span><span id="line-40"> *</span>
<span class="source-line-no">041</span><span id="line-41"> * &lt;p&gt;</span>
<span class="source-line-no">042</span><span id="line-42"> * This class is thread-safe and can be used as a drop-in replacement for</span>
<span class="source-line-no">043</span><span id="line-43"> * &lt;c&gt;javax.activation.MimetypesFileTypeMap&lt;/c&gt; without requiring Jakarta Activation.</span>
<span class="source-line-no">044</span><span id="line-44"> *</span>
<span class="source-line-no">045</span><span id="line-45"> * &lt;h5 class='section'&gt;Example:&lt;/h5&gt;</span>
<span class="source-line-no">046</span><span id="line-46"> * &lt;p class='bjava'&gt;</span>
<span class="source-line-no">047</span><span id="line-47"> *    &lt;jc&gt;// Basic usage&lt;/jc&gt;</span>
<span class="source-line-no">048</span><span id="line-48"> *    MimeTypeDetector &lt;jv&gt;detector&lt;/jv&gt; = MimeTypeDetector.builder().build();</span>
<span class="source-line-no">049</span><span id="line-49"> *    String &lt;jv&gt;mimeType&lt;/jv&gt; = &lt;jv&gt;detector&lt;/jv&gt;.getContentType(&lt;js&gt;"document.pdf"&lt;/js&gt;);</span>
<span class="source-line-no">050</span><span id="line-50"> *    &lt;jc&gt;// mimeType = "application/pdf"&lt;/jc&gt;</span>
<span class="source-line-no">051</span><span id="line-51"> *</span>
<span class="source-line-no">052</span><span id="line-52"> *    &lt;jc&gt;// Custom configuration&lt;/jc&gt;</span>
<span class="source-line-no">053</span><span id="line-53"> *    MimeTypeDetector &lt;jv&gt;custom&lt;/jv&gt; = MimeTypeDetector.builder()</span>
<span class="source-line-no">054</span><span id="line-54"> *       .addExtensionType(&lt;js&gt;"custom"&lt;/js&gt;, &lt;js&gt;"application/x-custom"&lt;/js&gt;)</span>
<span class="source-line-no">055</span><span id="line-55"> *       .addTypes(&lt;js&gt;"application/x-foo:foo,bar"&lt;/js&gt;)</span>
<span class="source-line-no">056</span><span id="line-56"> *       .setCacheSize(500)</span>
<span class="source-line-no">057</span><span id="line-57"> *       .build();</span>
<span class="source-line-no">058</span><span id="line-58"> * &lt;/p&gt;</span>
<span class="source-line-no">059</span><span id="line-59"> *</span>
<span class="source-line-no">060</span><span id="line-60"> * &lt;h5 class='section'&gt;See Also:&lt;/h5&gt;&lt;ul&gt;</span>
<span class="source-line-no">061</span><span id="line-61"> *    &lt;li class='jm'&gt;{@link Files#probeContentType(Path)}</span>
<span class="source-line-no">062</span><span id="line-62"> *    &lt;li class='jm'&gt;&lt;c&gt;javax.activation.MimetypesFileTypeMap&lt;/c&gt; (legacy class, not available in Java 11+)</span>
<span class="source-line-no">063</span><span id="line-63"> * &lt;/ul&gt;</span>
<span class="source-line-no">064</span><span id="line-64"> */</span>
<span class="source-line-no">065</span><span id="line-65">public class MimeTypeDetector {</span>
<span class="source-line-no">066</span><span id="line-66">   /**</span>
<span class="source-line-no">067</span><span id="line-67">    * Builder class for creating MimeTypeDetector instances.</span>
<span class="source-line-no">068</span><span id="line-68">    */</span>
<span class="source-line-no">069</span><span id="line-69">   public static class Builder {</span>
<span class="source-line-no">070</span><span id="line-70">      private final Map&lt;String,String&gt; extMap = new ConcurrentHashMap&lt;&gt;();</span>
<span class="source-line-no">071</span><span id="line-71">      private final Map&lt;String,String&gt; fileMap = new ConcurrentHashMap&lt;&gt;();</span>
<span class="source-line-no">072</span><span id="line-72">      private boolean nioContentBasedDetection = true;</span>
<span class="source-line-no">073</span><span id="line-73">      private int cacheSize = 1000;</span>
<span class="source-line-no">074</span><span id="line-74">      private CacheMode cacheMode = FULL;</span>
<span class="source-line-no">075</span><span id="line-75">      private boolean cacheLogOnExit = false;</span>
<span class="source-line-no">076</span><span id="line-76">      private String defaultType = "application/octet-stream";</span>
<span class="source-line-no">077</span><span id="line-77"></span>
<span class="source-line-no">078</span><span id="line-78">      /**</span>
<span class="source-line-no">079</span><span id="line-79">       * Adds the default MIME type mappings.</span>
<span class="source-line-no">080</span><span id="line-80">       *</span>
<span class="source-line-no">081</span><span id="line-81">       * @return This builder.</span>
<span class="source-line-no">082</span><span id="line-82">       */</span>
<span class="source-line-no">083</span><span id="line-83">      public Builder addDefaultMappings() {</span>
<span class="source-line-no">084</span><span id="line-84">         return addTypes("application/epub+zip epub", "application/java-archive jar", "application/javascript js", "application/json json", "application/msword doc", "application/ogg ogx",</span>
<span class="source-line-no">085</span><span id="line-85">            "application/pdf pdf", "application/rtf rtf", "application/vnd.amazon.ebook azw", "application/vnd.apple.installer+xml mpkg", "application/vnd.mozilla.xul+xml xul",</span>
<span class="source-line-no">086</span><span id="line-86">            "application/vnd.ms-excel xls", "application/vnd.ms-powerpoint ppt", "application/vnd.oasis.opendocument.presentation odp", "application/vnd.oasis.opendocument.spreadsheet ods",</span>
<span class="source-line-no">087</span><span id="line-87">            "application/vnd.oasis.opendocument.text odt", "application/vnd.visio vsd", "application/x-7z-compressed 7z", "application/x-abiword abw", "application/x-bzip bz",</span>
<span class="source-line-no">088</span><span id="line-88">            "application/x-bzip2 bz2", "application/x-csh csh", "application/x-rar-compressed rar", "application/x-sh sh", "application/x-shockwave-flash swf", "application/x-tar tar",</span>
<span class="source-line-no">089</span><span id="line-89">            "application/xhtml+xml xhtml", "application/xml xml", "application/zip zip", "audio/aac aac", "audio/midi mid midi", "audio/ogg oga", "audio/webm weba", "audio/x-wav wav",</span>
<span class="source-line-no">090</span><span id="line-90">            "font/ttf ttf", "font/woff woff", "font/woff2 woff2", "image/gif gif", "image/jpeg jpeg jpg", "image/png png", "image/svg+xml svg", "image/tiff tif tiff", "image/webp webp",</span>
<span class="source-line-no">091</span><span id="line-91">            "image/x-icon ico", "text/calendar ics", "text/css css", "text/csv csv", "text/html htm html", "text/plain txt", "video/3gpp 3gp", "video/3gpp2 3g2", "video/mpeg mpeg",</span>
<span class="source-line-no">092</span><span id="line-92">            "video/ogg ogv", "video/webm webm", "video/x-msvideo avi");</span>
<span class="source-line-no">093</span><span id="line-93">      }</span>
<span class="source-line-no">094</span><span id="line-94"></span>
<span class="source-line-no">095</span><span id="line-95">      /**</span>
<span class="source-line-no">096</span><span id="line-96">       * Adds an extension type mapping.</span>
<span class="source-line-no">097</span><span id="line-97">       *</span>
<span class="source-line-no">098</span><span id="line-98">       * @param ext The file extension.</span>
<span class="source-line-no">099</span><span id="line-99">       * @param type The MIME type.</span>
<span class="source-line-no">100</span><span id="line-100">       * @return This builder.</span>
<span class="source-line-no">101</span><span id="line-101">       * @throws IllegalArgumentException If ext or type is null or blank.</span>
<span class="source-line-no">102</span><span id="line-102">       */</span>
<span class="source-line-no">103</span><span id="line-103">      public Builder addExtensionType(String ext, String type) {</span>
<span class="source-line-no">104</span><span id="line-104">         assertArgNotNullOrBlank("ext", ext);</span>
<span class="source-line-no">105</span><span id="line-105">         assertArgNotNullOrBlank("type", type);</span>
<span class="source-line-no">106</span><span id="line-106">         extMap.put(ext.toLowerCase(), type);</span>
<span class="source-line-no">107</span><span id="line-107">         return this;</span>
<span class="source-line-no">108</span><span id="line-108">      }</span>
<span class="source-line-no">109</span><span id="line-109"></span>
<span class="source-line-no">110</span><span id="line-110">      /**</span>
<span class="source-line-no">111</span><span id="line-111">       * Adds a file type mapping.</span>
<span class="source-line-no">112</span><span id="line-112">       *</span>
<span class="source-line-no">113</span><span id="line-113">       * @param name The file name or path pattern.</span>
<span class="source-line-no">114</span><span id="line-114">       * @param type The MIME type.</span>
<span class="source-line-no">115</span><span id="line-115">       * @return This builder.</span>
<span class="source-line-no">116</span><span id="line-116">       * @throws IllegalArgumentException If name or type is null or blank.</span>
<span class="source-line-no">117</span><span id="line-117">       */</span>
<span class="source-line-no">118</span><span id="line-118">      public Builder addFileType(String name, String type) {</span>
<span class="source-line-no">119</span><span id="line-119">         assertArgNotNullOrBlank("name", name);</span>
<span class="source-line-no">120</span><span id="line-120">         assertArgNotNullOrBlank("type", type);</span>
<span class="source-line-no">121</span><span id="line-121">         fileMap.put(name, type);</span>
<span class="source-line-no">122</span><span id="line-122">         return this;</span>
<span class="source-line-no">123</span><span id="line-123">      }</span>
<span class="source-line-no">124</span><span id="line-124"></span>
<span class="source-line-no">125</span><span id="line-125">      /**</span>
<span class="source-line-no">126</span><span id="line-126">       * Enables or disables NIO content-based detection.</span>
<span class="source-line-no">127</span><span id="line-127">       *</span>
<span class="source-line-no">128</span><span id="line-128">       * @param value Whether to enable NIO content-based detection.</span>
<span class="source-line-no">129</span><span id="line-129">       * @return This builder.</span>
<span class="source-line-no">130</span><span id="line-130">       */</span>
<span class="source-line-no">131</span><span id="line-131">      public Builder addNioContentBasedDetection(boolean value) {</span>
<span class="source-line-no">132</span><span id="line-132">         nioContentBasedDetection = value;</span>
<span class="source-line-no">133</span><span id="line-133">         return this;</span>
<span class="source-line-no">134</span><span id="line-134">      }</span>
<span class="source-line-no">135</span><span id="line-135"></span>
<span class="source-line-no">136</span><span id="line-136">      /**</span>
<span class="source-line-no">137</span><span id="line-137">       * Adds MIME type mappings from mime.types file format.</span>
<span class="source-line-no">138</span><span id="line-138">       *</span>
<span class="source-line-no">139</span><span id="line-139">       * &lt;p&gt;</span>
<span class="source-line-no">140</span><span id="line-140">       * Each line should follow the format:</span>
<span class="source-line-no">141</span><span id="line-141">       * &lt;pre&gt;</span>
<span class="source-line-no">142</span><span id="line-142">       * text/html        html htm</span>
<span class="source-line-no">143</span><span id="line-143">       * image/png        png</span>
<span class="source-line-no">144</span><span id="line-144">       * application/json json</span>
<span class="source-line-no">145</span><span id="line-145">       * &lt;/pre&gt;</span>
<span class="source-line-no">146</span><span id="line-146">       *</span>
<span class="source-line-no">147</span><span id="line-147">       * &lt;p&gt;</span>
<span class="source-line-no">148</span><span id="line-148">       * This method supports both individual lines as varargs and entire</span>
<span class="source-line-no">149</span><span id="line-149">       * mime.types file contents as a single string (which will be split on newlines).</span>
<span class="source-line-no">150</span><span id="line-150">       *</span>
<span class="source-line-no">151</span><span id="line-151">       * @param mimeTypesLines The MIME types lines or file contents.</span>
<span class="source-line-no">152</span><span id="line-152">       * @return This builder.</span>
<span class="source-line-no">153</span><span id="line-153">       */</span>
<span class="source-line-no">154</span><span id="line-154">      public Builder addTypes(String...mimeTypesLines) {</span>
<span class="source-line-no">155</span><span id="line-155">         for (var input : mimeTypesLines) {</span>
<span class="source-line-no">156</span><span id="line-156">            if (ne(input)) {</span>
<span class="source-line-no">157</span><span id="line-157">               // Split on newlines to handle both individual lines and file contents</span>
<span class="source-line-no">158</span><span id="line-158">               var lines = input.split("\\r?\\n");</span>
<span class="source-line-no">159</span><span id="line-159">               for (var line : lines) {</span>
<span class="source-line-no">160</span><span id="line-160">                  if (ne(line) &amp;&amp; ! line.trim().startsWith("#")) {</span>
<span class="source-line-no">161</span><span id="line-161">                     var parts = line.trim().split("\\s+");</span>
<span class="source-line-no">162</span><span id="line-162">                     if (parts.length &gt;= 2) {</span>
<span class="source-line-no">163</span><span id="line-163">                        var mimeType = parts[0];</span>
<span class="source-line-no">164</span><span id="line-164">                        for (var i = 1; i &lt; parts.length; i++) {</span>
<span class="source-line-no">165</span><span id="line-165">                           addExtensionType(parts[i], mimeType);</span>
<span class="source-line-no">166</span><span id="line-166">                        }</span>
<span class="source-line-no">167</span><span id="line-167">                     }</span>
<span class="source-line-no">168</span><span id="line-168">                  }</span>
<span class="source-line-no">169</span><span id="line-169">               }</span>
<span class="source-line-no">170</span><span id="line-170">            }</span>
<span class="source-line-no">171</span><span id="line-171">         }</span>
<span class="source-line-no">172</span><span id="line-172">         return this;</span>
<span class="source-line-no">173</span><span id="line-173">      }</span>
<span class="source-line-no">174</span><span id="line-174"></span>
<span class="source-line-no">175</span><span id="line-175">      /**</span>
<span class="source-line-no">176</span><span id="line-176">       * Builds the MimeTypeDetector instance.</span>
<span class="source-line-no">177</span><span id="line-177">       *</span>
<span class="source-line-no">178</span><span id="line-178">       * @return A new MimeTypeDetector instance.</span>
<span class="source-line-no">179</span><span id="line-179">       */</span>
<span class="source-line-no">180</span><span id="line-180">      public MimeTypeDetector build() {</span>
<span class="source-line-no">181</span><span id="line-181">         return new MimeTypeDetector(this);</span>
<span class="source-line-no">182</span><span id="line-182">      }</span>
<span class="source-line-no">183</span><span id="line-183"></span>
<span class="source-line-no">184</span><span id="line-184">      /**</span>
<span class="source-line-no">185</span><span id="line-185">       * Enables or disables cache logging on exit.</span>
<span class="source-line-no">186</span><span id="line-186">       *</span>
<span class="source-line-no">187</span><span id="line-187">       * @param value Whether to log cache statistics on exit.</span>
<span class="source-line-no">188</span><span id="line-188">       * @return This builder.</span>
<span class="source-line-no">189</span><span id="line-189">       */</span>
<span class="source-line-no">190</span><span id="line-190">      public Builder setCacheLogOnExit(boolean value) {</span>
<span class="source-line-no">191</span><span id="line-191">         cacheLogOnExit = value;</span>
<span class="source-line-no">192</span><span id="line-192">         return this;</span>
<span class="source-line-no">193</span><span id="line-193">      }</span>
<span class="source-line-no">194</span><span id="line-194"></span>
<span class="source-line-no">195</span><span id="line-195">      /**</span>
<span class="source-line-no">196</span><span id="line-196">       * Sets the caching mode for MIME type lookups.</span>
<span class="source-line-no">197</span><span id="line-197">       *</span>
<span class="source-line-no">198</span><span id="line-198">       * &lt;p&gt;</span>
<span class="source-line-no">199</span><span id="line-199">       * Available modes:</span>
<span class="source-line-no">200</span><span id="line-200">       * &lt;ul&gt;</span>
<span class="source-line-no">201</span><span id="line-201">       *    &lt;li&gt;{@link CacheMode#NONE NONE} - No caching (always recompute)</span>
<span class="source-line-no">202</span><span id="line-202">       *    &lt;li&gt;{@link CacheMode#WEAK WEAK} - Weak caching (uses {@link java.util.WeakHashMap})</span>
<span class="source-line-no">203</span><span id="line-203">       *    &lt;li&gt;{@link CacheMode#FULL FULL} - Full caching (uses {@link java.util.concurrent.ConcurrentHashMap}, default)</span>
<span class="source-line-no">204</span><span id="line-204">       * &lt;/ul&gt;</span>
<span class="source-line-no">205</span><span id="line-205">       *</span>
<span class="source-line-no">206</span><span id="line-206">       * @param value The caching mode.</span>
<span class="source-line-no">207</span><span id="line-207">       * @return This builder.</span>
<span class="source-line-no">208</span><span id="line-208">       */</span>
<span class="source-line-no">209</span><span id="line-209">      public Builder setCacheMode(CacheMode value) {</span>
<span class="source-line-no">210</span><span id="line-210">         cacheMode = value;</span>
<span class="source-line-no">211</span><span id="line-211">         return this;</span>
<span class="source-line-no">212</span><span id="line-212">      }</span>
<span class="source-line-no">213</span><span id="line-213"></span>
<span class="source-line-no">214</span><span id="line-214">      /**</span>
<span class="source-line-no">215</span><span id="line-215">       * Sets the cache size.</span>
<span class="source-line-no">216</span><span id="line-216">       *</span>
<span class="source-line-no">217</span><span id="line-217">       * @param value The maximum cache size.</span>
<span class="source-line-no">218</span><span id="line-218">       * @return This builder.</span>
<span class="source-line-no">219</span><span id="line-219">       */</span>
<span class="source-line-no">220</span><span id="line-220">      public Builder setCacheSize(int value) {</span>
<span class="source-line-no">221</span><span id="line-221">         cacheSize = value;</span>
<span class="source-line-no">222</span><span id="line-222">         return this;</span>
<span class="source-line-no">223</span><span id="line-223">      }</span>
<span class="source-line-no">224</span><span id="line-224"></span>
<span class="source-line-no">225</span><span id="line-225">      /**</span>
<span class="source-line-no">226</span><span id="line-226">       * Sets the default MIME type for unknown files.</span>
<span class="source-line-no">227</span><span id="line-227">       *</span>
<span class="source-line-no">228</span><span id="line-228">       * @param value The default MIME type.</span>
<span class="source-line-no">229</span><span id="line-229">       * @return This builder.</span>
<span class="source-line-no">230</span><span id="line-230">       */</span>
<span class="source-line-no">231</span><span id="line-231">      public Builder setDefaultType(String value) {</span>
<span class="source-line-no">232</span><span id="line-232">         defaultType = value;</span>
<span class="source-line-no">233</span><span id="line-233">         return this;</span>
<span class="source-line-no">234</span><span id="line-234">      }</span>
<span class="source-line-no">235</span><span id="line-235">   }</span>
<span class="source-line-no">236</span><span id="line-236"></span>
<span class="source-line-no">237</span><span id="line-237">   /**</span>
<span class="source-line-no">238</span><span id="line-238">    * Default MIME type detector instance.</span>
<span class="source-line-no">239</span><span id="line-239">    */</span>
<span class="source-line-no">240</span><span id="line-240">   public static final MimeTypeDetector DEFAULT = builder().addDefaultMappings().build();</span>
<span class="source-line-no">241</span><span id="line-241"></span>
<span class="source-line-no">242</span><span id="line-242">   /**</span>
<span class="source-line-no">243</span><span id="line-243">    * Creates a new builder for MimeTypeDetector.</span>
<span class="source-line-no">244</span><span id="line-244">    *</span>
<span class="source-line-no">245</span><span id="line-245">    * @return A new builder.</span>
<span class="source-line-no">246</span><span id="line-246">    */</span>
<span class="source-line-no">247</span><span id="line-247">   public static Builder builder() {</span>
<span class="source-line-no">248</span><span id="line-248">      return new Builder();</span>
<span class="source-line-no">249</span><span id="line-249">   }</span>
<span class="source-line-no">250</span><span id="line-250"></span>
<span class="source-line-no">251</span><span id="line-251">   private final Map&lt;String,String&gt; extMap;</span>
<span class="source-line-no">252</span><span id="line-252">   private final Map&lt;String,String&gt; fileMap;</span>
<span class="source-line-no">253</span><span id="line-253">   private final Cache&lt;String,String&gt; cache;</span>
<span class="source-line-no">254</span><span id="line-254">   private final boolean nioContentBasedDetection;</span>
<span class="source-line-no">255</span><span id="line-255">   private final String defaultType;</span>
<span class="source-line-no">256</span><span id="line-256"></span>
<span class="source-line-no">257</span><span id="line-257">   /**</span>
<span class="source-line-no">258</span><span id="line-258">    * Constructor.</span>
<span class="source-line-no">259</span><span id="line-259">    *</span>
<span class="source-line-no">260</span><span id="line-260">    * @param builder The builder.</span>
<span class="source-line-no">261</span><span id="line-261">    */</span>
<span class="source-line-no">262</span><span id="line-262">   private MimeTypeDetector(Builder builder) {</span>
<span class="source-line-no">263</span><span id="line-263">      this.extMap = new ConcurrentHashMap&lt;&gt;(builder.extMap);</span>
<span class="source-line-no">264</span><span id="line-264">      this.fileMap = new ConcurrentHashMap&lt;&gt;(builder.fileMap);</span>
<span class="source-line-no">265</span><span id="line-265">      this.nioContentBasedDetection = builder.nioContentBasedDetection;</span>
<span class="source-line-no">266</span><span id="line-266">      this.defaultType = builder.defaultType;</span>
<span class="source-line-no">267</span><span id="line-267"></span>
<span class="source-line-no">268</span><span id="line-268">      // Create cache for file-based lookups</span>
<span class="source-line-no">269</span><span id="line-269">      var cacheBuilder = Cache.of(String.class, String.class).maxSize(builder.cacheSize).cacheMode(builder.cacheMode);</span>
<span class="source-line-no">270</span><span id="line-270"></span>
<span class="source-line-no">271</span><span id="line-271">      if (builder.cacheLogOnExit) {</span>
<span class="source-line-no">272</span><span id="line-272">         cacheBuilder.logOnExit("MimeTypeDetector");</span>
<span class="source-line-no">273</span><span id="line-273">      }</span>
<span class="source-line-no">274</span><span id="line-274"></span>
<span class="source-line-no">275</span><span id="line-275">      this.cache = cacheBuilder.build();</span>
<span class="source-line-no">276</span><span id="line-276">   }</span>
<span class="source-line-no">277</span><span id="line-277"></span>
<span class="source-line-no">278</span><span id="line-278">   /**</span>
<span class="source-line-no">279</span><span id="line-279">    * Clears the MIME type cache.</span>
<span class="source-line-no">280</span><span id="line-280">    *</span>
<span class="source-line-no">281</span><span id="line-281">    * &lt;p&gt;</span>
<span class="source-line-no">282</span><span id="line-282">    * This method can be called to free memory or when you want to ensure</span>
<span class="source-line-no">283</span><span id="line-283">    * fresh MIME type detection (e.g., after files have been modified).</span>
<span class="source-line-no">284</span><span id="line-284">    */</span>
<span class="source-line-no">285</span><span id="line-285">   public void clearCache() {</span>
<span class="source-line-no">286</span><span id="line-286">      cache.clear();</span>
<span class="source-line-no">287</span><span id="line-287">   }</span>
<span class="source-line-no">288</span><span id="line-288"></span>
<span class="source-line-no">289</span><span id="line-289">   /**</span>
<span class="source-line-no">290</span><span id="line-290">    * Returns the number of cache hits since the cache was created.</span>
<span class="source-line-no">291</span><span id="line-291">    *</span>
<span class="source-line-no">292</span><span id="line-292">    * @return The number of cache hits.</span>
<span class="source-line-no">293</span><span id="line-293">    */</span>
<span class="source-line-no">294</span><span id="line-294">   public int getCacheHits() { return cache.getCacheHits(); }</span>
<span class="source-line-no">295</span><span id="line-295"></span>
<span class="source-line-no">296</span><span id="line-296">   /**</span>
<span class="source-line-no">297</span><span id="line-297">    * Returns the current cache size.</span>
<span class="source-line-no">298</span><span id="line-298">    *</span>
<span class="source-line-no">299</span><span id="line-299">    * @return The number of cached MIME type entries.</span>
<span class="source-line-no">300</span><span id="line-300">    */</span>
<span class="source-line-no">301</span><span id="line-301">   public int getCacheSize() { return cache.size(); }</span>
<span class="source-line-no">302</span><span id="line-302"></span>
<span class="source-line-no">303</span><span id="line-303">   /**</span>
<span class="source-line-no">304</span><span id="line-304">    * Determines the MIME type of a file based on its name or path.</span>
<span class="source-line-no">305</span><span id="line-305">    *</span>
<span class="source-line-no">306</span><span id="line-306">    * &lt;p&gt;</span>
<span class="source-line-no">307</span><span id="line-307">    * This method uses multiple strategies to determine the MIME type:</span>
<span class="source-line-no">308</span><span id="line-308">    * &lt;ol&gt;</span>
<span class="source-line-no">309</span><span id="line-309">    *   &lt;li&gt;Checks cache first for previously determined MIME types</span>
<span class="source-line-no">310</span><span id="line-310">    *   &lt;li&gt;If the file exists, uses {@link Files#probeContentType(Path)} for content-based detection</span>
<span class="source-line-no">311</span><span id="line-311">    *   &lt;li&gt;Falls back to extension-based mapping for common file types</span>
<span class="source-line-no">312</span><span id="line-312">    *   &lt;li&gt;Returns the configured default type for unknown types</span>
<span class="source-line-no">313</span><span id="line-313">    * &lt;/ol&gt;</span>
<span class="source-line-no">314</span><span id="line-314">    *</span>
<span class="source-line-no">315</span><span id="line-315">    * &lt;p&gt;</span>
<span class="source-line-no">316</span><span id="line-316">    * Results are cached to improve performance for repeated lookups of the same files.</span>
<span class="source-line-no">317</span><span id="line-317">    *</span>
<span class="source-line-no">318</span><span id="line-318">    * @param fileName The name or path of the file.</span>
<span class="source-line-no">319</span><span id="line-319">    * @return The MIME type of the file, or the default type if unknown.</span>
<span class="source-line-no">320</span><span id="line-320">    */</span>
<span class="source-line-no">321</span><span id="line-321">   public String getContentType(String fileName) {</span>
<span class="source-line-no">322</span><span id="line-322">      if (e(fileName)) {</span>
<span class="source-line-no">323</span><span id="line-323">         return defaultType;</span>
<span class="source-line-no">324</span><span id="line-324">      }</span>
<span class="source-line-no">325</span><span id="line-325"></span>
<span class="source-line-no">326</span><span id="line-326">      // Check file map first (for specific file mappings)</span>
<span class="source-line-no">327</span><span id="line-327">      var fileMimeType = fileMap.get(fileName);</span>
<span class="source-line-no">328</span><span id="line-328">      if (nn(fileMimeType)) {</span>
<span class="source-line-no">329</span><span id="line-329">         return fileMimeType;</span>
<span class="source-line-no">330</span><span id="line-330">      }</span>
<span class="source-line-no">331</span><span id="line-331"></span>
<span class="source-line-no">332</span><span id="line-332">      // Use cache with supplier for automatic cache management</span>
<span class="source-line-no">333</span><span id="line-333">      return cache.get(fileName, () -&gt; determineMimeType(fileName));</span>
<span class="source-line-no">334</span><span id="line-334">   }</span>
<span class="source-line-no">335</span><span id="line-335"></span>
<span class="source-line-no">336</span><span id="line-336">   /**</span>
<span class="source-line-no">337</span><span id="line-337">    * Determines the MIME type without caching (internal method).</span>
<span class="source-line-no">338</span><span id="line-338">    *</span>
<span class="source-line-no">339</span><span id="line-339">    * @param fileName The name or path of the file.</span>
<span class="source-line-no">340</span><span id="line-340">    * @return The MIME type of the file.</span>
<span class="source-line-no">341</span><span id="line-341">    */</span>
<span class="source-line-no">342</span><span id="line-342">   private String determineMimeType(String fileName) {</span>
<span class="source-line-no">343</span><span id="line-343">      // Try Java NIO's content-based detection first</span>
<span class="source-line-no">344</span><span id="line-344">      if (nioContentBasedDetection) {</span>
<span class="source-line-no">345</span><span id="line-345">         try {</span>
<span class="source-line-no">346</span><span id="line-346">            var path = Paths.get(fileName);</span>
<span class="source-line-no">347</span><span id="line-347">            if (Files.exists(path)) {</span>
<span class="source-line-no">348</span><span id="line-348">               var contentType = Files.probeContentType(path);</span>
<span class="source-line-no">349</span><span id="line-349">               if (ne(contentType)) {</span>
<span class="source-line-no">350</span><span id="line-350">                  return contentType;</span>
<span class="source-line-no">351</span><span id="line-351">               }</span>
<span class="source-line-no">352</span><span id="line-352">            }</span>
<span class="source-line-no">353</span><span id="line-353">         } catch (@SuppressWarnings("unused") Exception e) {</span>
<span class="source-line-no">354</span><span id="line-354">            // Fall back to extension-based detection</span>
<span class="source-line-no">355</span><span id="line-355">         }</span>
<span class="source-line-no">356</span><span id="line-356">      }</span>
<span class="source-line-no">357</span><span id="line-357"></span>
<span class="source-line-no">358</span><span id="line-358">      // Fall back to extension-based detection</span>
<span class="source-line-no">359</span><span id="line-359">      var extension = getFileExtension(fileName);</span>
<span class="source-line-no">360</span><span id="line-360">      if (ne(extension)) {</span>
<span class="source-line-no">361</span><span id="line-361">         var mimeType = extMap.get(extension.toLowerCase());</span>
<span class="source-line-no">362</span><span id="line-362">         if (nn(mimeType)) {</span>
<span class="source-line-no">363</span><span id="line-363">            return mimeType;</span>
<span class="source-line-no">364</span><span id="line-364">         }</span>
<span class="source-line-no">365</span><span id="line-365">      }</span>
<span class="source-line-no">366</span><span id="line-366"></span>
<span class="source-line-no">367</span><span id="line-367">      // Default fallback</span>
<span class="source-line-no">368</span><span id="line-368">      return defaultType;</span>
<span class="source-line-no">369</span><span id="line-369">   }</span>
<span class="source-line-no">370</span><span id="line-370">}</span>




























































</pre>
</div>
</main>
</body>
</html>
